@model ActivityDetailViewModel

@{
    ViewData["Title"] = "Activity Details";
}

<link rel="stylesheet" href="~/css/activity/activity_details.css" asp-append-version="true">

<div>
    <nav>
        <div class="logo">
            <i class="fa-brands fa-facebook fa-4x"></i>
            <span>EventListener</span>
        </div>
        <div class="buttongroup-and-user">
            @if (User.Identity.IsAuthenticated)
            {
                <a asp-controller="activity" asp-action="create">
                    <button class="create-activity-btn">
                        <i class="fa-solid fa-plus"></i>
                        สร้างกิจกรรม
                    </button>
                </a>
                <button class="noti-btn">
                    <i class="fa-regular fa-bell"></i>
                    การเเจ้งเตือน
                </button>
                <div class="user-dropdown">
                    <button class="user-avatar-btn" onclick="drop()"><img src="~/user.png" alt=""
                            class="avatar-img"></button>
                    <div id="dropdown-content" class="dropdown-content">
                        <a asp-controller="profile" asp-action="index">โปรไฟล์</a>
                        <a asp-controller="account" asp-action="logout">ออกจากระบบ</a>
                    </div>
                </div>
            }
            else
            {
                <a asp-controller="account" asp-action="login">
                    <button class="login-btn">
                        Login
                    </button>
                </a>
                <a asp-controller="account" asp-action="register">
                    <button class="register-btn">
                        Register
                    </button>
                </a>
            }
        </div>
    </nav>

    <main>
        <div class="activity-img">
            <img src="@Model.Activity.ActivityImageUrl" alt="">
        </div>
        <div class="content">
            <div class="activity-details">
                <div class="group-tag-topic">
                    <span class="tag-topic">@Model.Activity.ActivityTagId</span>
                </div>
                <h4 class="start-datetime">
                    @Model.Activity.StartDate.ToString("dddd", new System.Globalization.CultureInfo("th-Th")),
                    @Model.Activity.StartDate.ToString("d MMMM yyyy", new System.Globalization.CultureInfo("th-Th")),
                    @Model.Activity.StartTime.ToString(@"hh\:mm") น.
                </h4>
                <br>
                <h3 class="topic">
                    @Model.Activity.ActivityName
                </h3>
                <br>
                <h4 class="location">
                    <i class="fa-solid fa-location-dot fa-lg" style="color: #ff0000;"></i>
                    @Model.Activity.Location
                </h4>
                <br>
                <p class="detail">
                    รายละเอียด : @Model.Activity.Detail
                </p>
                <br>
                <div class="btn-group-for-owner-or-user">
                    @if (User.Identity.IsAuthenticated)
                    {
                        @if (User.Identity.Name == Model.Activity.User.UserName)
                        {
                            <button class="chat-btn">
                                <i class="fa-regular fa-comment fa-lg"></i>
                                <span>เเชท</span>
                            </button>
                            <button class="edit-activity-btn">
                                <i class="fa-regular fa-pen-to-square fa-lg"></i>
                                <span>เเก้ไข</span>
                            </button>
                        }
                        else
                        {
                            @if (Model.isUserJoin)
                            {
                                <button class="chat-btn">
                                    <i class="fa-regular fa-comment fa-lg"></i>
                                    <span>เเชท</span>
                                </button>
                            }
                            else
                            {
                                <button class="join-btn" onclick="join_activity('@Model.ActivityId')">
                                    <i class="fa-solid fa-right-to-bracket fa-lg"></i>
                                    <span>เข้าร่วม</span>
                                </button>
                            }
                        }
                    }
                    else
                    {
                        <button class="join-btn" onclick="join_activity('@Model.ActivityId')" id="join-btn">
                            <i class="fa-solid fa-right-to-bracket fa-lg"></i>
                            <span>เข้าร่วม</span>
                        </button>
                    }
                </div>
            </div>
            <div class="owner">
                <h3>เจ้าของ</h3>
                <img src="https://i.pinimg.com/564x/69/2b/76/692b76e52092469fd10487cd0f4c62e6.jpg" alt="">
                <h4>@Model.Activity.User.UserName</h4>
            </div>
        </div>
        <div class="participant-container">
            <h2 id="userJoinActivityCount">@Model.UserJoinActivityCount ผู้เข้าร่วม </h2>
            <div class="all-participant" id="all-participant">
                @foreach (var p in Model.UserJoinActivity)
                {

                    @if (p.Status == "Accept")
                    {
                        <div class="participant">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTlw3sKpafl78LFg_NjOxVX7ui2VVUbSDkaCQ&s"
                                alt="">
                            <h4>@p.User.UserName</h4>
                        </div>
                    }
                }
            </div>
        </div>
        @if (User.Identity.IsAuthenticated && User.Identity.Name == Model.Activity.User.UserName)
        {
            <div class="participant-container">
                <h2 id="userJoinActivityCount">@Model.UserJoinActivityCount คำขอเข้าร่วม</h2>
                <div class="all-participant" id="all-participant">
                    @foreach (var p in Model.UserJoinActivity)
                    {
                        @if (p.Status == "wait")
                        {
                            
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTlw3sKpafl78LFg_NjOxVX7ui2VVUbSDkaCQ&s" alt="">
                                <h4>@p.User.UserName</h4>
                                
                                @{
                                    string formatDate = p.ActivityCreatedAt.ToString("yyyy-MM-dd HH:mm:ss"); // ✅ แปลง Format ให้เป็น String
                                }

                                <span>@formatDate</span>

                                <button onclick="manage_submit('@p.UserId', '@p.ActivityOwnerId', '@formatDate', 'Accept')">Accept</button>
                                <button onclick="manage_submit('@p.UserId', '@p.ActivityOwnerId', '@formatDate', 'Deny')">Deny</button>
                            </div>
                        }
                    }
                </div>
            </div>
        }
    </main>
</div>

<script src="~/js/activity/user_dropdown.js" asp-append-version="true"></script>
<script src="~/js/activity/join_activity.js" asp-append-version="true"></script>
<script>
    function manage_submit(userId,ownerId,createAt,status) {
        var xhr = new XMLHttpRequest();
        var url = "/Activity/UpdateParticipantStatus";

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        var data = "userId=" + encodeURIComponent(userId) +
                "&activityOwnerId=" + encodeURIComponent(ownerId) +
                "&activityCreatedAt=" + encodeURIComponent(createAt) +
                "&status=" + encodeURIComponent(status);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    alert(response.message);
                    location.reload(); // รีโหลดหน้าเพื่ออัปเดต UI
                } else {
                    alert("เกิดข้อผิดพลาด: " + xhr.responseText);
                }
            }
        };

        xhr.send(data);
        }
</script>